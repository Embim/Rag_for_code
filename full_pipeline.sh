#!/bin/bash
#
# ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğ° AlphaRAG Ğ½Ğ° A100 80GB
# Ğ•Ğ”Ğ˜ĞĞĞ¯ ĞœĞĞ”Ğ•Ğ›Ğ¬: Qwen3-32B (8-bit) Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ·Ğ°Ğ´Ğ°Ñ‡
#
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
#   bash full_pipeline.sh
#

set -e  # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘              ĞŸĞĞ›ĞĞ«Ğ™ ĞŸĞĞ™ĞŸĞ›ĞĞ™Ğ ALPHARAG ĞĞ A100 80GB                           â•‘"
echo "â•‘              Ğ•Ğ´Ğ¸Ğ½Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ: Qwen3-32B (8-bit)                                â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ĞĞ¨Ğ˜Ğ‘ĞšĞ]${NC} $1"
    exit 1
}

warning() {
    echo -e "${YELLOW}[ĞŸĞ Ğ•Ğ”Ğ£ĞŸĞ Ğ•Ğ–Ğ”Ğ•ĞĞ˜Ğ•]${NC} $1"
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° GPU
log "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° GPU..."
if ! command -v nvidia-smi &> /dev/null; then
    error "nvidia-smi Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½! Ğ£Ğ±ĞµĞ´Ğ¸ÑÑŒ Ñ‡Ñ‚Ğ¾ CUDA ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°."
fi

nvidia-smi --query-gpu=name,memory.total --format=csv,noheader
echo ""

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Python
log "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Python..."
if ! command -v python &> /dev/null; then
    error "Python Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!"
fi

python --version
echo ""

# ============================================================================
# Ğ¨ĞĞ“ 1: Ğ—Ğ°Ğ¿ÑƒÑĞº Weaviate
# ============================================================================
log "Ğ¨ĞĞ“ 1/5: Ğ—Ğ°Ğ¿ÑƒÑĞº Weaviate..."

if ! command -v docker-compose &> /dev/null; then
    error "docker-compose Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½! Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸ Docker."
fi

docker-compose up -d
sleep 10

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
log "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Weaviate..."
for i in {1..30}; do
    if curl -sf http://localhost:8080/v1/meta > /dev/null 2>&1; then
        log "âœ… Weaviate Ğ³Ğ¾Ñ‚Ğ¾Ğ²!"
        break
    fi

    if [ $i -eq 30 ]; then
        error "Weaviate Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ»ÑÑ Ğ·Ğ° 30 ÑĞµĞºÑƒĞ½Ğ´"
    fi

    echo -n "."
    sleep 1
done
echo ""

# ============================================================================
# Ğ¨ĞĞ“ 2: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
# ============================================================================
log "Ğ¨ĞĞ“ 2/5: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²..."

if [ -f "data/processed/chunks.csv" ]; then
    warning "chunks.csv ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼..."
else
    python main_pipeline.py chunk || error "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²"
    log "âœ… Ğ§Ğ°Ğ½ĞºĞ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹!"
fi
echo ""

# ============================================================================
# Ğ¨ĞĞ“ 3: ĞŸÑ€ĞµĞ´Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· Qwen3-32B (4-6 Ñ‡Ğ°ÑĞ¾Ğ²)
# ============================================================================
log "Ğ¨ĞĞ“ 3/5: ĞŸÑ€ĞµĞ´Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· Qwen3-32B..."
log "â±ï¸  ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ: 4-6 Ñ‡Ğ°ÑĞ¾Ğ²"
log "ğŸ’¾ VRAM: ~32-34 GB"

if [ -f "data/processed/chunks_cleaned.csv" ]; then
    warning "chunks_cleaned.csv ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
    read -p "ĞŸĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ? (y/N): " recreate
    if [[ $recreate =~ ^[Yy]$ ]]; then
        python scripts/preprocess_documents_qwen25.py || error "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞµ"
    fi
else
    # ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼ (yes)
    yes | python scripts/preprocess_documents_qwen25.py || error "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞµ"
fi

log "âœ… ĞŸÑ€ĞµĞ´Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!"
echo ""

# ============================================================================
# Ğ¨ĞĞ“ 4: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ embeddings Ñ‡ĞµÑ€ĞµĞ· BGE-M3 (2-3 Ñ‡Ğ°ÑĞ°)
# ============================================================================
log "Ğ¨ĞĞ“ 4/5: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ embeddings Ñ‡ĞµÑ€ĞµĞ· BGE-M3..."
log "â±ï¸  ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ: 2-3 Ñ‡Ğ°ÑĞ°"
log "ğŸ’¾ VRAM: ~2-3 GB"

python main_pipeline.py build --input data/processed/chunks_cleaned.csv --force || error "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ embeddings"

log "âœ… Embeddings ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ Ğ² Weaviate!"
echo ""

# ============================================================================
# Ğ¨ĞĞ“ 5: Inference Ñ Qwen3-32B reranker (8-12 Ñ‡Ğ°ÑĞ¾Ğ²)
# ============================================================================
log "Ğ¨ĞĞ“ 5/5: Inference Ñ Qwen3-32B reranker..."
log "â±ï¸  ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ: 8-12 Ñ‡Ğ°ÑĞ¾Ğ²"
log "ğŸ’¾ VRAM: ~32-34 GB"

python main_pipeline.py search || error "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ inference"

log "âœ… Inference Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!"
echo ""

# ============================================================================
# Ğ˜Ğ¢ĞĞ“Ğ˜
# ============================================================================
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                              âœ… Ğ“ĞĞ¢ĞĞ’Ğ!                                      â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

log "Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹:"
log "  ğŸ“„ Submission: outputs/submission.csv"

if [ -f "outputs/submission.csv" ]; then
    lines=$(wc -l < outputs/submission.csv)
    log "  ğŸ“Š Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾: $((lines - 1))"

    echo ""
    log "ĞŸĞµÑ€Ğ²Ñ‹Ğµ 5 ÑÑ‚Ñ€Ğ¾Ğº:"
    head -6 outputs/submission.csv
fi

echo ""
log "Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸:"
log "  1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ submission.csv"
log "  2. Ğ•ÑĞ»Ğ¸ accuracy < 0.8, Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ² src/config.py:"
log "     - TOP_K_DENSE, TOP_K_BM25, TOP_K_RERANK"
log "     - HYBRID_ALPHA (Ğ±Ğ°Ğ»Ğ°Ğ½Ñ dense/BM25)"
log "  3. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·: python main_pipeline.py search"
echo ""

log "ğŸ¯ ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ°Ñ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ: 0.70-0.80+"
