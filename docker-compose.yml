services:
  # ==========================================================================
  # Neo4j - Knowledge Graph Database
  # ==========================================================================
  neo4j:
    image: neo4j:5.15.0
    container_name: code-rag-neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"   # HTTP (Browser UI)
      - "7687:7687"   # Bolt protocol
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    environment:
      # Authentication
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-password}

      # Memory settings (adjust based on available RAM)
      NEO4J_server_memory_heap_initial__size: 4G
      NEO4J_server_memory_heap_max__size: 16G
      NEO4J_server_memory_pagecache_size: 8G

      # Performance
      NEO4J_dbms_memory_transaction_total_max: 4G
      NEO4J_PLUGINS: '["apoc"]'

      # Logging
      NEO4J_dbms_logs_debug_level: INFO

    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==========================================================================
  # Weaviate - Vector Database
  # ==========================================================================
  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:1.31.0
    container_name: code-rag-weaviate
    restart: unless-stopped
    depends_on:
      neo4j:
        condition: service_healthy
    ports:
      - "8080:8080"
      - "50051:50051"
    volumes:
      - weaviate_data:/var/lib/weaviate
    environment:
      # Базовые настройки
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'

      # Отключаем встроенные модули векторизации (мы передаем собственные эмбеддинги)
      DEFAULT_VECTORIZER_MODULE: 'none'
      ENABLE_MODULES: ''

      # A100 80GB оптимизация - максимальная производительность
      ASYNC_INDEXING: 'true'
      LIMIT_RESOURCES: 'false'  # Не ограничиваем ресурсы
      # GOMEMLIMIT: '8GiB'  # Максимум памяти (оставляем 20GB системе)

      # Отключаем телеметрию
      DISABLE_TELEMETRY: 'true'

      # Настройки кластера (для single-node)
      CLUSTER_HOSTNAME: 'node1'

      # Логирование
      LOG_LEVEL: 'info'

    # # Ограничения ресурсов для A100 сервера
    # deploy:
    #   resources:
    #     limits:
    #       memory: 64G  # Выделяем 64GB RAM для Weaviate
    #     reservations:
    #       memory: 32G  # Резервируем минимум 32GB

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  weaviate_data:
    driver: local
