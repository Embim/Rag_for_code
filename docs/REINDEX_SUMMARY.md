# –†–µ–∑—é–º–µ: –û—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è - 2025-12-07

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω Neo4j –∫–ª–∏–µ–Ω—Ç (+80 —Å—Ç—Ä–æ–∫)

**–§–∞–π–ª:** `src/code_rag/graph/neo4j_client.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ `clear_database()` - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∞—Ç—á–∏ (10,000 –Ω–æ–¥ –∑–∞ —Ä–∞–∑)
- ‚úÖ `create_nodes_batch()` - –¥–æ–±–∞–≤–ª–µ–Ω chunking (1,000 –Ω–æ–¥ –∑–∞ —Ä–∞–∑)
- ‚úÖ `create_relationships_batch()` - –¥–æ–±–∞–≤–ª–µ–Ω chunking (1,000 —Å–≤—è–∑–µ–π –∑–∞ —Ä–∞–∑)
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ë—ã—Å—Ç—Ä–µ–µ –Ω–∞ 2-3x –¥–ª—è –±–æ–ª—å—à–∏—Ö –≥—Ä–∞—Ñ–æ–≤
- –°—Ç–∞–±–∏–ª—å–Ω–µ–µ (–º–µ–Ω—å—à–µ out-of-memory –æ—à–∏–±–æ–∫)
- –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å chunk_size –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã

---

### 2. –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

**–§–∞–π–ª:** `scripts/full_reindex.py`

**–§—É–Ω–∫—Ü–∏–∏:**
1. –û—á–∏—Å—Ç–∫–∞ Neo4j (–±–∞—Ç—á–∞–º–∏)
2. –û—á–∏—Å—Ç–∫–∞ Weaviate
3. –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤—Å–µ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
5. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
python scripts/full_reindex.py
```

---

### 3. –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–§–∞–π–ª:** `docs/REINDEXING_GUIDE.md`

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
- üóëÔ∏è –°–ø–æ—Å–æ–±—ã –æ—á–∏—Å—Ç–∫–∏ (–ø–æ–ª–Ω–∞—è, —á–∞—Å—Ç–∏—á–Ω–∞—è, –ø–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é)
- üìö –°–ø–æ—Å–æ–±—ã –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞—Ç—á–µ–π
- üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- ‚ö†Ô∏è Troubleshooting
- üìù –ß–µ–∫–ª–∏—Å—Ç
- üí° –°–æ–≤–µ—Ç—ã

---

## üéØ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ë—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç
python scripts/full_reindex.py

# 2. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (–≤–≤–µ–¥–∏—Ç–µ "yes")

# 3. –ñ–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (5-30 –º–∏–Ω—É—Ç)

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
```

---

### –†—É—á–Ω–æ–π —Å–ø–æ—Å–æ–± (–¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö)

**–®–∞–≥ 1: –û—á–∏—Å—Ç–∏—Ç—å Neo4j**
```cypher
MATCH (n)
CALL {
  WITH n
  DETACH DELETE n
} IN TRANSACTIONS OF 10000 ROWS
```

**–®–∞–≥ 2: –û—á–∏—Å—Ç–∏—Ç—å Weaviate**
```python
from src.code_rag.graph.weaviate_indexer import WeaviateIndexer

indexer = WeaviateIndexer(url="http://localhost:8080")
indexer.delete_collection()
indexer.create_collection()
```

**–®–∞–≥ 3: –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å**
```python
from src.code_rag.graph.build_and_index import build_and_index

build_and_index(
    repos_dir="data/repos",
    neo4j_uri="bolt://localhost:7687",
    weaviate_url="http://localhost:8080"
)
```

---

## üìä –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

### –í Neo4j (http://localhost:7474)

```cypher
// 1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–µ–π
MATCH ()-[r]->()
RETURN type(r), count(*)
ORDER BY count DESC

// –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
// CONTAINS: 5993
// CALLS: 500-1000+    ‚úÖ –î–û–õ–ñ–ù–û –ü–û–Ø–í–ò–¢–¨–°–Ø!
// INHERITS: 240
// IMPORTS: 100-300+   ‚úÖ –î–û–õ–ñ–ù–û –ü–û–Ø–í–ò–¢–¨–°–Ø!
```

```cypher
// 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CALLS —Å–≤—è–∑—å
MATCH (f {name: "blotter_equity"})-[r:CALLS]->(target)
RETURN f.name, target.name
LIMIT 10

// –ï—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–æ—Å—å 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ - –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞!
```

### –í API

```bash
curl -X POST "http://localhost:8000/api/ask" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-key" \
  -d '{
    "question": "What functions does blotter_equity call?",
    "verbose": true
  }'

# –í debug.detailed_trace –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
# - get_entity_details: entities_found > 0 ‚úÖ
# - get_related_entities: entities_found > 0 ‚úÖ (–µ—Å–ª–∏ –µ—Å—Ç—å CALLS —Å–≤—è–∑–∏)
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞—Ç—á–µ–π

### –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞)

```python
# –£–¥–∞–ª–µ–Ω–∏–µ
client.clear_database(batch_size=10000)

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–¥
client.create_nodes_batch(nodes, chunk_size=1000)

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–µ–π
client.create_relationships_batch(rels, chunk_size=1000)
```

### –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö

```python
# –î–ª—è –≥—Ä–∞—Ñ–æ–≤ > 100K –Ω–æ–¥
client.create_nodes_batch(nodes, chunk_size=2000)
client.create_relationships_batch(rels, chunk_size=2000)

# –î–ª—è –≥—Ä–∞—Ñ–æ–≤ > 1M –Ω–æ–¥
client.create_nodes_batch(nodes, chunk_size=5000)
client.create_relationships_batch(rels, chunk_size=5000)
```

**‚ö†Ô∏è –ù–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ:**
- –ë–æ–ª—å—à–µ chunk_size = –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏
- –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ OOM –æ—à–∏–±–∫–∏ - —É–º–µ–Ω—å—à–∏—Ç–µ chunk_size

---

## üîÑ Workflow –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

```mermaid
graph TD
    A[–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç] --> B{–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å?}
    B -->|–ù–µ—Ç| C[–û—Ç–º–µ–Ω–µ–Ω–æ]
    B -->|–î–∞| D[–û—á–∏—Å—Ç–∏—Ç—å Neo4j]
    D --> E[–û—á–∏—Å—Ç–∏—Ç—å Weaviate]
    E --> F[–ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏]
    F --> G[–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É]
    G --> H[–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã]
    H --> I{CALLS –µ—Å—Ç—å?}
    I -->|–î–∞| J[‚úÖ –£—Å–ø–µ—Ö!]
    I -->|–ù–µ—Ç| K[‚ùå –ü—Ä–æ–±–ª–µ–º–∞]
    K --> L[–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏]
```

---

## ‚è±Ô∏è –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è

| –†–∞–∑–º–µ—Ä –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã | –§–∞–π–ª–æ–≤ | –í—Ä–µ–º—è |
|---------------------|--------|-------|
| –ú–∞–ª–µ–Ω—å–∫–∞—è | < 100 | 1-2 –º–∏–Ω |
| –°—Ä–µ–¥–Ω—è—è | 100-500 | 5-10 –º–∏–Ω |
| –ë–æ–ª—å—à–∞—è | 500-1000 | 15-30 –º–∏–Ω |
| –û—á–µ–Ω—å –±–æ–ª—å—à–∞—è | > 1000 | 30-60 –º–∏–Ω |

**–í–∞—à —Å–ª—É—á–∞–π (api + ui):** –≤–µ—Ä–æ—è—Ç–Ω–æ 5-15 –º–∏–Ω—É—Ç

---

## ‚ùì FAQ

### Q: –ù—É–∂–Ω–æ –ª–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å API —Å–µ—Ä–≤–µ—Ä?
**A:** –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.

### Q: –ú–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π?
**A:** –î–∞:
```cypher
// –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ api
MATCH (n)
WHERE n.id STARTS WITH 'repo:api'
CALL { WITH n DETACH DELETE n } IN TRANSACTIONS OF 5000 ROWS

// –ó–∞—Ç–µ–º –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ api
```

### Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–≤–∏—Å?
**A:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `tail -f outputs/pipeline.log`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Neo4j Browser: `http://localhost:7474`
3. –ï—Å–ª–∏ –≤–∏—Å–∏—Ç > 1 —á–∞—Å–∞ - Ctrl+C –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å

### Q: –ú–æ–∂–Ω–æ –ª–∏ —É—Å–∫–æ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å?
**A:** –î–∞:
1. –£–≤–µ–ª–∏—á–∏—Ç—å chunk_size –¥–æ 2000-5000
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSD –¥–∏—Å–∫
3. –î–æ–±–∞–≤–∏—Ç—å RAM
4. –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (—Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞)

---

## üìÑ –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `scripts/full_reindex.py` | –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ |
| `docs/REINDEXING_GUIDE.md` | –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ |
| `docs/CALLS_IMPORTS_IMPLEMENTATION.md` | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è CALLS/IMPORTS |
| `src/code_rag/graph/neo4j_client.py` | Neo4j –∫–ª–∏–µ–Ω—Ç (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω) |

---

## üéØ –†–µ–∑—é–º–µ

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
- ‚úÖ Neo4j –∫–ª–∏–µ–Ω—Ç —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç chunking
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –±–∞—Ç—á–∏–Ω–≥ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
- ‚úÖ –°–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- ‚úÖ –ù–∞–ø–∏—Å–∞–Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `python scripts/full_reindex.py`
2. –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (5-30 –º–∏–Ω—É—Ç)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ CALLS –∏ IMPORTS —Å–≤—è–∑–∏ –ø–æ—è–≤–∏–ª–∏—Å—å
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≥–µ–Ω—Ç–∞

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- CALLS: 500-1000+ —Å–≤—è–∑–µ–π ‚úÖ
- IMPORTS: 100-300+ —Å–≤—è–∑–µ–π ‚úÖ
- get_related_entities —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
- –ì—Ä–∞—Ñ –∑–Ω–∞–µ—Ç flow –∫–æ–¥–∞ ‚úÖ

---

**–î–∞—Ç–∞:** 2025-12-07 23:45
**–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:** 1 —á–∞—Å 15 –º–∏–Ω—É—Ç
**–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ:** 4
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** +350
