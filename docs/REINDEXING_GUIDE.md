# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∞ –∑–Ω–∞–Ω–∏–π

## üéØ –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å?

–ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∫–æ–≥–¥–∞:
- ‚úÖ –ò–∑–º–µ–Ω–∏–ª—Å—è –ø–∞—Ä—Å–µ—Ä (–¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è, –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–≤—è–∑–µ–π)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ç–∏–ø—ã —Å–≤—è–∑–µ–π (CALLS, IMPORTS)
- ‚úÖ –ò–∑–º–µ–Ω–∏–ª–∞—Å—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥—Ä–∞—Ñ–∞
- ‚úÖ –î–∞–Ω–Ω—ã–µ –≤ Neo4j –∏–ª–∏ Weaviate –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã
- ‚úÖ –ù—É–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞

---

## üóëÔ∏è –°–ø–æ—Å–æ–±—ã –æ—á–∏—Å—Ç–∫–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

**–ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç:**
```bash
python scripts/full_reindex.py
```

–°–∫—Ä–∏–ø—Ç:
1. ‚ùì –°–ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
2. üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç Neo4j (–±–∞—Ç—á–∞–º–∏ –ø–æ 10,000 –Ω–æ–¥)
3. üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç Weaviate
4. üìö –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç –≤—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
5. üìä –ü–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—á–∏—Å—Ç–∫–∞ —Ç–æ–ª—å–∫–æ Neo4j

**–ß–µ—Ä–µ–∑ Python:**
```python
from src.code_rag.graph.neo4j_client import Neo4jClient

client = Neo4jClient(
    uri="bolt://localhost:7687",
    user="neo4j",
    password="password"
)

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ (–±–∞—Ç—á–∞–º–∏)
client.clear_database(batch_size=10000)
client.close()
```

**–ß–µ—Ä–µ–∑ Neo4j Browser** (http://localhost:7474):
```cypher
// –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–æ–¥—ã –∏ —Å–≤—è–∑–∏ (–±–∞—Ç—á–∞–º–∏)
MATCH (n)
CALL {
  WITH n
  DETACH DELETE n
} IN TRANSACTIONS OF 10000 ROWS
```

**–ò–ª–∏:**
```cypher
// –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤—è–∑–∏ (–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–¥—ã)
MATCH ()-[r]->()
CALL {
  WITH r
  DELETE r
} IN TRANSACTIONS OF 10000 ROWS
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```cypher
// –£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ api —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
MATCH (n)
WHERE n.id STARTS WITH 'repo:api'
CALL {
  WITH n
  DETACH DELETE n
} IN TRANSACTIONS OF 5000 ROWS
```

---

## üìö –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è

### –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±)

```bash
# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (—Å –æ—á–∏—Å—Ç–∫–æ–π)
python scripts/full_reindex.py

# –¢–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (–±–µ–∑ –æ—á–∏—Å—Ç–∫–∏)
python scripts/reindex_weaviate.py  # –ï—Å–ª–∏ —Ç–∞–∫–æ–π —Å–∫—Ä–∏–ø—Ç –µ—Å—Ç—å
```

---

### –ß–µ—Ä–µ–∑ Python –∫–æ–¥

```python
from src.code_rag.graph.build_and_index import build_and_index
from pathlib import Path

# –ü—É—Ç—å –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º
repos_dir = Path("data/repos")

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é
stats = build_and_index(
    repos_dir=str(repos_dir),
    neo4j_uri="bolt://localhost:7687",
    neo4j_user="neo4j",
    neo4j_password="password",
    weaviate_url="http://localhost:8080",
)

print(f"–°–æ–∑–¥–∞–Ω–æ –Ω–æ–¥: {stats['nodes_created']}")
print(f"–°–æ–∑–¥–∞–Ω–æ —Å–≤—è–∑–µ–π: {stats['relationships_created']}")
```

---

## ‚öôÔ∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞—Ç—á–µ–π

### –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)

| –û–ø–µ—Ä–∞—Ü–∏—è | Chunk Size | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|------------|----------|
| **–£–¥–∞–ª–µ–Ω–∏–µ** | 10,000 | –ë–∞—Ç—á–∞–º–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö –≥—Ä–∞—Ñ–æ–≤ |
| **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–¥** | 1,000 | –ü–æ 1000 –Ω–æ–¥ –∑–∞ —Ä–∞–∑ |
| **–°–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–µ–π** | 1,000 | –ü–æ 1000 —Å–≤—è–∑–µ–π –∑–∞ —Ä–∞–∑ |

### –ú–æ–∂–Ω–æ –ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å?

**–î–∞!** –ó–∞–≤–∏—Å–∏—Ç –æ—Ç RAM –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö:

| –†–∞–∑–º–µ—Ä –≥—Ä–∞—Ñ–∞ | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π chunk_size |
|--------------|--------------------------|
| < 10K –Ω–æ–¥ | 500-1000 ‚úÖ |
| 10K-100K –Ω–æ–¥ | 1000-2000 ‚úÖ |
| > 100K –Ω–æ–¥ | 2000-5000 ‚ö†Ô∏è |
| > 1M –Ω–æ–¥ | 5000-10000 ‚ö†Ô∏è |

**–ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å:**
```python
# –í neo4j_client.py
nodes_created = client.create_nodes_batch(nodes, chunk_size=2000)  # –ë—ã–ª–æ 1000
rels_created = client.create_relationships_batch(rels, chunk_size=2000)
```

**–ö–æ–º–ø—Ä–æ–º–∏—Å—Å:**
- üü¢ **–ë–æ–ª—å—à–µ chunk_size** = –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏
- üü¢ **–ú–µ–Ω—å—à–µ chunk_size** = –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–¥
```cypher
MATCH (n)
RETURN labels(n) as type, count(*) as count
ORDER BY count DESC
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
File: 500-1000
Function: 2000-5000
Class: 200-500
Method: 3000-8000
...
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–µ–π
```cypher
MATCH ()-[r]->()
RETURN type(r) as relationship_type, count(*) as count
ORDER BY count DESC
```

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
```
CONTAINS: 5993
INHERITS: 240
CALLS: 0        ‚ùå
IMPORTS: 0      ‚ùå
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π (–û–ñ–ò–î–ê–ï–¢–°–Ø):**
```
CONTAINS: 5993
CALLS: 500-1000+    ‚úÖ –ù–û–í–û–ï!
INHERITS: 240
IMPORTS: 100-300+   ‚úÖ –ù–û–í–û–ï!
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
```cypher
// –ù–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—é
MATCH (f {name: "blotter_equity"})
RETURN f

// –ß—Ç–æ –æ–Ω–∞ –≤—ã–∑—ã–≤–∞–µ—Ç
MATCH (f {name: "blotter_equity"})-[r:CALLS]->(target)
RETURN f.name, type(r), target.name
LIMIT 10
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Weaviate
```bash
curl http://localhost:8080/v1/schema
```

---

## üìä –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

| –†–∞–∑–º–µ—Ä –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ | –í—Ä–µ–º—è |
|----------------------|-------------------|--------|
| –ú–∞–ª–µ–Ω—å–∫–∞—è | < 100 | 1-2 –º–∏–Ω |
| –°—Ä–µ–¥–Ω—è—è | 100-500 | 5-10 –º–∏–Ω |
| –ë–æ–ª—å—à–∞—è | 500-1000 | 15-30 –º–∏–Ω |
| –û—á–µ–Ω—å –±–æ–ª—å—à–∞—è | > 1000 | 30-60 –º–∏–Ω |

**–§–∞–∫—Ç–æ—Ä—ã:**
- CPU (–ø–∞—Ä—Å–∏–Ω–≥ AST)
- RAM (–±–∞—Ç—á–∏)
- GPU (embeddings)
- –î–∏—Å–∫ (—á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤)

---

## ‚ö†Ô∏è Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "Out of memory"

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –£–º–µ–Ω—å—à–∏—Ç—å chunk_size
client.create_nodes_batch(nodes, chunk_size=500)  # –ë—ã–ª–æ 1000
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Transaction timeout"

**–†–µ—à–µ–Ω–∏–µ:**
```cypher
// –£–≤–µ–ª–∏—á–∏—Ç—å batch_size –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
MATCH (n)
CALL {
  WITH n
  DETACH DELETE n
} IN TRANSACTIONS OF 5000 ROWS  -- –ë—ã–ª–æ 10000
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Connection lost"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Neo4j –∑–∞–ø—É—â–µ–Ω: `http://localhost:7474`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Weaviate –∑–∞–ø—É—â–µ–Ω: `http://localhost:8080`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã:
   ```bash
   docker-compose restart neo4j weaviate
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: "No CALLS relationships found"

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `python_parser.py` –∏–∑–≤–ª–µ–∫–∞–µ—Ç –≤—ã–∑–æ–≤—ã:
   ```cypher
   // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å metadata
   MATCH (f:Function)
   WHERE f.code CONTAINS "def "
   RETURN f.name, f.code
   LIMIT 5
   ```

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

- [ ] Neo4j –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ–¥—ã
- [ ] Neo4j –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç CALLS —Å–≤—è–∑–∏
- [ ] Neo4j –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç IMPORTS —Å–≤—è–∑–∏
- [ ] Weaviate —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–µ–∫—Ç–æ—Ä—ã
- [ ] API `/api/search` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] API `/api/ask` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] `get_entity_details` –Ω–∞—Ö–æ–¥–∏—Ç —Å—É—â–Ω–æ—Å—Ç–∏
- [ ] `get_related_entities` –Ω–∞—Ö–æ–¥–∏—Ç —Å–≤—è–∑–∏
- [ ] –ê–≥–µ–Ω—Ç –º–æ–∂–µ—Ç —Ç—Ä–µ–π—Å–∏—Ç—å –ø–æ—Ç–æ–∫–∏

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –û—á–∏—Å—Ç–∏—Ç—å –∏ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ
python scripts/full_reindex.py

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ Neo4j
# –û—Ç–∫—Ä—ã—Ç—å http://localhost:7474 –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
# MATCH ()-[r]->() RETURN type(r), count(*)

# 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API
curl -X POST "http://localhost:8000/api/ask" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-key" \
  -d '{
    "question": "What functions does blotter_equity call?",
    "verbose": true
  }'
```

---

## üí° –°–æ–≤–µ—Ç—ã

1. **–î–µ–ª–∞–π—Ç–µ backup** –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π:
   ```bash
   # Neo4j dump
   neo4j-admin dump --database=neo4j --to=backup.dump
   ```

2. **–ò–Ω–¥–µ–∫—Å–∏—Ä—É–π—Ç–µ –ø–æ —á–∞—Å—Ç—è–º** –¥–ª—è –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤:
   ```python
   # –°–Ω–∞—á–∞–ª–∞ –æ–¥–∏–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
   build_and_index(repos_dir="data/repos/api", ...)

   # –ü–æ—Ç–æ–º –≤—Ç–æ—Ä–æ–π
   build_and_index(repos_dir="data/repos/ui", ...)
   ```

3. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å** —á–µ—Ä–µ–∑ –ª–æ–≥–∏:
   ```bash
   tail -f outputs/pipeline.log
   ```

4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** –µ—Å–ª–∏ –º–µ–¥–ª–µ–Ω–Ω–æ:
   ```python
   import cProfile
   cProfile.run('build_and_index(...)', 'stats.prof')
   ```

---

## üìÑ –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `docs/CALLS_IMPORTS_IMPLEMENTATION.md` - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è CALLS/IMPORTS
- `docs/CRITICAL_FIXES_2025-12-07.md` - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- `docs/LOG_ANALYSIS_2025-12-07.md` - –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-07
**–ê–≤—Ç–æ—Ä:** Claude Code
