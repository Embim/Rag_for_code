# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç 2025-12-07

## –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### 1. ‚ùå –û—à–∏–±–∫–∞ JSON –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
Classification failed: '\n  "type"'. Content: N/A
```

**–ü—Ä–∏—á–∏–Ω–∞:**
Regex –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è JSON –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã. –ü–∞—Ç—Ç–µ—Ä–Ω `r'\{[^{}]*"type"[^{}]*\}'` –Ω–µ —Ä–∞–±–æ—Ç–∞–ª, –µ—Å–ª–∏ LLM –≤–æ–∑–≤—Ä–∞—â–∞–ª JSON —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏.

**–†–µ—à–µ–Ω–∏–µ:**
`src/agents/orchestrator.py:200-216`

- –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–∞—Ä—Å–∏—Ç—å JSON –Ω–∞–ø—Ä—è–º—É—é
- –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π regex: `r'\{(?:[^{}]|(?:\{[^{}]*\}))*\}'`
- Fallback –Ω–∞ keyword-based classification –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–§–∞–π–ª:** `src/agents/orchestrator.py`

---

### 2. ‚ùå Semantic Search –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "No results found"

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
No results found for query: 'equity instrument booking'
No results found for query: 'equity instrument booking form'
...
```

**–ü—Ä–∏—á–∏–Ω–∞:**
–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è:

1. **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã –≤ SearchConfig**
   - –ö–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `config.repositories` –∏ `config.node_types`
   - –ù–æ `SearchConfig` –Ω–µ –∏–º–µ–ª —ç—Ç–∏—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤
   - –ú–µ—Ç–æ–¥ `_apply_config_overrides` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞—Ç—Ä–∏–±—É—Ç—ã –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç (`if hasattr(config, key)`)
   - –ü–æ—ç—Ç–æ–º—É —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–ª–∏—Å—å

2. **–ù–µ—è–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è**
   - –î–∞–∂–µ –∫–æ–≥–¥–∞ Weaviate –≤–æ–∑–≤—Ä–∞—â–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –æ–Ω–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–ª–∏—Å—å –ø–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É `config.repositories`

**–†–µ—à–µ–Ω–∏–µ:**
`src/config/search.py:80-81`

```python
repositories: Optional[List[str]] = None  # Multi-repository filter (plural)
node_types: Optional[List[str]] = None  # Node type filter
```

–î–æ–±–∞–≤–∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã –≤ SearchConfig.

**–§–∞–π–ª—ã:**
- `src/config/search.py`
- `src/code_rag/retrieval/code_retriever.py` (–¥–æ–±–∞–≤–∏–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

### 3. ‚ùå –û—à–∏–±–∫–∞ –≤ ExactSearchTool

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
TypeError: ExactSearchTool.execute() missing 1 required positional argument: 'name'
```

**–ü—Ä–∏—á–∏–Ω–∞:**
LLM agent –ø–µ—Ä–µ–¥–∞–≤–∞–ª –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ (`query`, `entity_name`), –Ω–æ –º–µ—Ç–æ–¥ —Ç—Ä–µ–±–æ–≤–∞–ª —Å—Ç—Ä–æ–≥–æ `name`.

**–†–µ—à–µ–Ω–∏–µ:**
`src/agents/tools.py:175-199`

```python
async def execute(
    self,
    name: Optional[str] = None,
    entity_name: Optional[str] = None,
    query: Optional[str] = None,
    entity_type: Optional[str] = None,
    **kwargs
) -> Dict[str, Any]:
    # Try to extract entity name from various parameter names
    entity_search_name = name or entity_name or query
    if not entity_search_name:
        return {'success': False, 'error': '...'}
```

**–§–∞–π–ª:** `src/agents/tools.py`

---

### 4. ‚ùå TypeError –≤ fallback enrichment

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
TypeError: sequence item 0: expected str instance, dict found
```

**–ü—Ä–∏—á–∏–Ω–∞:**
Fallback enrichment –æ–∂–∏–¥–∞–ª `base_answer: str`, –Ω–æ –ø–æ–ª—É—á–∞–ª dict –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ LLM –≤—ã–∑–æ–≤–∞.

**–†–µ—à–µ–Ω–∏–µ:**
`src/agents/code_explorer.py:681-688`

```python
# Handle case where base_answer might be a dict
if isinstance(base_answer, dict):
    base_answer = base_answer.get('answer', base_answer.get('content', str(base_answer)))
if not isinstance(base_answer, str):
    base_answer = str(base_answer)
```

–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –º–µ—Å—Ç–µ –≤—ã–∑–æ–≤–∞ (—Å—Ç—Ä–æ–∫–∏ 268-272).

**–§–∞–π–ª:** `src/agents/code_explorer.py`

---

### 5. üìù –£–ª—É—á—à–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –∞–≥–µ–Ω—Ç–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
`src/agents/code_explorer.py:100-131`

–î–æ–±–∞–≤–ª–µ–Ω—ã –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:

```
- exact_search: Find entity by exact name
  Parameters: name (string), entity_type (optional)
  Example: {"tool": "exact_search", "params": {"name": "calculate_total"}}
```

–≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç LLM –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.

**–§–∞–π–ª:** `src/agents/code_explorer.py`

---

### 6. üîç –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **CodeRetriever** (`src/code_rag/retrieval/code_retriever.py`):
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Weaviate (—Å—Ç—Ä–æ–∫–∞ 355)
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ repository (—Å—Ç—Ä–æ–∫–∏ 358-365)
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 377-383)
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 240)

–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤:
```
Weaviate returned 10 results for query 'equity'
Filtering by repositories: ['frontend', 'backend']
After repository filter: 10 -> 5 results
Total results across 1 queries: 5
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –¢–µ—Å—Ç Weaviate Search

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `scripts/test_weaviate_search.py` –¥–ª—è –ø—Ä—è–º–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∏—Å–∫–∞:

```bash
python scripts/test_weaviate_search.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Found 10 results:

1. _process_equity_instruments (Method)
   File: app/backend/v2/portfolio/report_pipeline/services/theoretical_data_cash_service.py
   Repo: api
```

‚úÖ **Weaviate —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!**

---

## –û—Å—Ç–∞–≤—à–∏–µ—Å—è —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ü—Ä–æ–±–ª–µ–º–∞ —Å directory listing

–ê–≥–µ–Ω—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:
- `src/components`
- `src/views`
- `src/api`

–ù–æ –∏—Ö –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `data/repos`.

**–ü—Ä–∏—á–∏–Ω–∞:**
–ö–æ–¥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–µ –≤ `data/repos`, –∞ –≥–¥–µ-—Ç–æ –µ—â–µ. –ù—É–∂–Ω–æ:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ—Ç–∫—É–¥–∞ –∏–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è —Ñ–∞–π–ª—ã (repository "api")
2. –û–±–Ω–æ–≤–∏—Ç—å `ListFilesTool` —á—Ç–æ–±—ã –æ–Ω –∑–Ω–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
3. –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å fallback - –µ—Å–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏—Å–∫–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥ –ø—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∫–æ–¥—É
- –û–±–Ω–æ–≤–∏—Ç—å `ListFilesTool` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏

### 2. –£–ª—É—á—à–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è LLM

–¢–µ–∫—É—â–∏–π SYSTEM_PROMPT –Ω–µ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

```
Common patterns:
- If semantic_search returns no results, try:
  - Simplifying the query
  - Using broader terms
  - Trying related concepts

- If directory listing fails:
  - Start with root directory listing
  - Check repository structure first
```

---

---

### 6. ‚ùå Visual Guide Agent –Ω–µ –º–æ–∂–µ—Ç –∏–∑–≤–ª–µ—á—å entities

**–ü—Ä–æ–±–ª–µ–º–∞:**
```json
{
  "answer": "‚ùå **Visualization Failed**\n\nNo entities found for: equity instrument booking process workflow",
  "sources": []
}
```

–ù–æ –≤ –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ:
```
Weaviate returned 50 results
Answer enriched: 3082 ‚Üí 7401 chars
```

**–ü—Ä–∏—á–∏–Ω–∞:**
Code Explorer —É—Å–ø–µ—à–Ω–æ –Ω–∞—Ö–æ–¥–∏–ª entities, –Ω–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª –∏—Ö –≤ –ø–æ–ª–µ `sources`. Visual Guide Agent –∏—Å–∫–∞–ª —ç—Ç–æ –ø–æ–ª–µ –∏ –ø–æ–ª—É—á–∞–ª –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.

**–†–µ—à–µ–Ω–∏–µ:**
`src/agents/code_explorer.py:280-290, 681-741, 318-323, 260-264`

1. **–î–æ–±–∞–≤–∏–ª–∏ –º–µ—Ç–æ–¥ `_extract_sources_from_memory`** (—Å—Ç—Ä–æ–∫–∏ 681-741):
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç entities –∏–∑ –≤—Å–µ—Ö tool results
   - –î–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É–µ—Ç –ø–æ ID
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç semantic_search, get_entity_details, get_related_entities
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ 50 sources

2. **–î–æ–±–∞–≤–∏–ª–∏ sources –≤ success response** (—Å—Ç—Ä–æ–∫–∏ 280-290):
   ```python
   sources = self._extract_sources_from_memory(memory)
   return {
       'success': True,
       'answer': enriched_answer,
       'sources': sources,  # ‚úÖ NEW
       ...
   }
   ```

3. **–î–æ–±–∞–≤–∏–ª–∏ sources –≤ incomplete/error responses** (—Å—Ç—Ä–æ–∫–∏ 318-323, 260-264):
   - –î–∞–∂–µ –µ—Å–ª–∏ –∞–≥–µ–Ω—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª, Visual Guide –ø–æ–ª—É—á–∏—Ç entities –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

**–§–∞–π–ª:** `src/agents/code_explorer.py`

---

## –ò—Ç–æ–≥–∏

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. JSON parsing –≤ orchestrator
2. Missing attributes –≤ SearchConfig (`repositories`, `node_types`)
3. Parameter handling –≤ ExactSearchTool
4. Type safety –≤ fallback enrichment
5. Tool documentation –¥–ª—è LLM
6. Diagnostic logging
7. **Sources extraction –¥–ª—è Visual Guide Agent** ‚≠ê –ù–û–í–û–ï

### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- Weaviate search **–†–ê–ë–û–¢–ê–ï–¢** (50 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è "equity instrument booking")
- Code Explorer **–†–ê–ë–û–¢–ê–ï–¢** (enrichment: 3082 ‚Üí 7401 chars)
- Visual Guide Agent **–î–û–õ–ñ–ï–ù –†–ê–ë–û–¢–ê–¢–¨** –ø–æ—Å–ª–µ restart
- Agent tools –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –£–ª—É—á—à–µ–Ω–∞ –æ—Ç–ª–∞–¥–∫–∞ —á–µ—Ä–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### üîÑ –¢—Ä–µ–±—É–µ—Ç—Å—è:
- **RESTART –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∫–æ–¥—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
